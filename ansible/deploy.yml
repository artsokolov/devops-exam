- name: Deploy Node.js app
  hosts: target
  become: true
  gather_facts: true

  vars:
    app_dir: /opt/myapp
    app_user: laborant
    service_name: myapp

  pre_tasks:
    - name: Ensure app user exists
      user:
        name: "{{ app_user }}"
        state: present

    - name: Update apt cache (Debian/Ubuntu)
      apt:
        update_cache: yes
      when: ansible_os_family == 'Debian'

  tasks:
    - name: Install prerequisites for NodeSource (Debian/Ubuntu)
      apt:
        name:
          - curl
          - ca-certificates
          - gnupg
          - rsync
        state: present
      when: ansible_os_family == 'Debian'

    - name: Setup NodeSource repo (Debian/Ubuntu)
      shell: curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
      when: ansible_os_family == 'Debian'

    - name: Install Node.js from NodeSource (Debian/Ubuntu)
      apt:
        name:
          - nodejs
        state: present
      when: ansible_os_family == 'Debian'

    - name: Install prerequisites for NodeSource (RedHat)
      yum:
        name:
          - curl
          - rsync
        state: present
      when: ansible_os_family == 'RedHat'

    - name: Setup NodeSource repo (RedHat)
      shell: curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
      when: ansible_os_family == 'RedHat'

    - name: Install Node.js from NodeSource (RedHat)
      yum:
        name:
          - nodejs
        state: present
      when: ansible_os_family == 'RedHat'

    - name: Install Node.js, npm and rsync (Alpine)
      apk:
        name:
          - nodejs
          - npm
          - rsync
        state: present
      when: ansible_os_family == 'Alpine'

    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"

    - name: Copy application files to target
      copy:
        src: "{{ playbook_dir }}/../"
        dest: "{{ app_dir }}/"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0644"

    - name: Remove excluded paths
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ app_dir }}/.git"
        - "{{ app_dir }}/node_modules"
        - "{{ app_dir }}/ansible"
        - "{{ app_dir }}/Dockerfile"
        - "{{ app_dir }}/Jenkinsfile"
        - "{{ app_dir }}/pod.yaml"

    - name: Ensure application files ownership
      file:
        path: "{{ app_dir }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: yes

    - name: Install production dependencies
      npm:
        path: "{{ app_dir }}"
        production: yes
      become_user: "{{ app_user }}"

    - name: Deploy systemd unit
      template:
        src: app.service.j2
        dest: "/etc/systemd/system/{{ service_name }}.service"
        owner: root
        group: root
        mode: "0644"

    - name: Reload systemd
      systemd:
        daemon_reload: true

    - name: Enable and restart app service
      systemd:
        name: "{{ service_name }}"
        state: restarted
        enabled: true
