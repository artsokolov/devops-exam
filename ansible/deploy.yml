- name: Deploy app
  hosts: target
  become: true

  vars:
    app_dir: /opt/myapp
    app_user: laborant

  tasks:
    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"

    - name: Copy application files to target
      copy:
        src: "{{ playbook_dir }}/../"
        dest: "{{ app_dir }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0644"
      exclude:
        - .git
        - node_modules
        - ansible
        - Dockerfile

    - name: Install dependencies
      npm:
        path: "{{ app_dir }}"
        production: yes
      become_user: "{{ app_user }}"

    - name: Restart app service
      systemd:
        name: myapp
        state: restarted
        enabled: true
